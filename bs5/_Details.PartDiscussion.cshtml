@inherits Custom.Hybrid.Razor12
@using ToSic.Razor.Blade;
@using System.Linq;
@{
  var discussionDomAttribute = "app-blog5-discussion-" + CmsContext.Module.Id;
  var blogPost = AsList(Data).FirstOrDefault();
  if (blogPost == null) {
    return;
  }
  var blogId = blogPost.EntityId;
}

<section @discussionDomAttribute @Edit.TagToolbar(App.Data["Comment"])>
  @{
    var comments = AsList(App.Data["Comment"]).Where(comment => comment.BlogPostFK == blogId).OrderByDescending(comment => comment.Created);
    var commentTotal = comments.Count();
  }

  <hr/>
  <h3 class="mb-4">@Resources.LabelComments (@commentTotal)</h3>
  <div class="container-fluid px-0">
    @Html.Partial("shared/_CommentInput.cshtml", new { IsFirstComment = commentTotal == 0 })
    
    @{
      var targets = AsList(comments).Where(comment => comment.Target.Count == 0);
    }
    @foreach (var target in targets) {
      @Html.Partial("shared/_Comment.cshtml", new { Comment = target });

      var replies = comments
        .Where(comment => (comment.Target as IEnumerable<dynamic>)
        .Any(p => p.EntityId == target.EntityId));

      for (var i = 0; i < replies.Count(); i++) {
        var reply = replies.ElementAt(i);
        @Html.Partial("shared/_Comment.cshtml", new { Comment = reply, ParentId = target.EntityId, IsVisible = i < 2 });
      }
      if (replies.Count() > 2) {
        <button type="button" class="btn btn-light btn-sm mb-4" app-blog5-show-all app-blog5-show-id="@target.EntityId" style="margin-left: 80px;">@Resources.ViewAllComments.Replace("[total]", replies.Count().ToString())</button>
      }
    }
  </div>
  <template app-blog5-reply-template>
    @Html.Partial("shared/_CommentInput.cshtml", new { IsReply = true })
  </template>
</section>

@Html.Partial("_DiscussionAssets.cshtml", new { BlogPostId = blogId })