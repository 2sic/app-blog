@using System.Web.UI.HtmlControls
<link rel="stylesheet" href="@App.Path/dist/style.css" data-enableoptimizations="true" />
<script src="@App.Path/dist/scripts.js" data-enableoptimizations="bottom"></script>
<script src="@App.Path/dist/sticky-sidebar.min.js" data-enableoptimizations="bottom"></script>
@using Connect.Koi;
@{	
	var lib = CreateInstance("_library.cshtml"); 
	var post = AsDynamic(Data["Default"]).First();
        var author = (post.Author.Count > 0) ? post.Author[0] : lib.unknownAuthor;
	var imgWidth = "800";
	var imgHeight = "400";
	var imgUrl = lib.GetSizedImgUrl(post.Image, imgHeight, imgWidth);

	// only add meta-tags if it's rendered as page - not when the search-index is accessing the template
	if (HttpContext.Current.Handler is Page)
	{
		lib.SetMetaAndTitle(post.MetaTitle, post.Title, post.MetaDescription, lib.StripHtml(post.Teaser));	

		var metaDesc = !String.IsNullOrEmpty(post.SharingDescription) ? post.SharingDescription : lib.StripHtml(post.Teaser);

		lib.SetOpenGraphHeaders( 
			post.Title, 
			App.Settings.Title, 
			Link.To(parameters: "post=" + post.UrlKey), 
			metaDesc, 
			imgUrl, 
			imgHeight,
			imgWidth
			);
	}

	 // get all posts as delived from the standard query
    var currCategory = Request.QueryString["category"];
    var currTag = Request.QueryString["tag"];
    var currUrl = DotNetNuke.Entities.Tabs.TabController.CurrentPage.FullUrl;

    // get all posts as delived from the standard query
    var cats = (IEnumerable<dynamic>)AsDynamic(App.Data["Category"]);

    var postsToShow = (IEnumerable<dynamic>)AsDynamic(Data["Default"]);

    // only apply this filter for non-editors
    if (!Permissions.UserMayEditContent)
    {
        postsToShow = postsToShow.Where(p => p.PublicationMoment <= DateTime.Now);
    }

    var postAllCategories = postsToShow;
    var categoryNumbers = cats.Select(ca => new {
        Category = ca,
        Count = postAllCategories.Where(p => ((IEnumerable<dynamic>)p.Categories).Any(c => c.EntityId == ca.EntityId)).Count()
    });
}
@if(post.IsPublished || Permissions.UserMayEditContent) {

	
<section class="app-blog">
 	
	<div class="row">
         <div @Koi.Class(@"bs3,unk='col-xs-12 col-sm-12 col-md-8 col-lg-8' bs4='col-xs-12 col-sm-12 col-md-12 col-lg-8 col-xl-8'")>
               
				<article class="sc-element post-detail">
				@Edit.Toolbar(post, actions: "edit")
					<div class="header">
						@if(!String.IsNullOrEmpty(post.Image)){
						<picture>
							<img src="@post.Image.ToLower()?w=800&amp;h=450&amp;mode=crop&amp;scale=both&amp;quality=90&amp;anchor=@post.CropAnchor" class="img-fluid" alt="@post.Title" />
						</picture>
						}
						
						<h1>@Html.Raw(post.Title.Replace("\n","<br/>"))</h1>
						<div class="details">
							<div class="person">
								<a href="@Link.To(parameters: "author=" + author.FullName)">
									<img src="@author.Image.ToLower()?w=40&amp;h=40&amp;mode=crop&amp;scale=both&amp;quality=80" alt="@author.FullName" />
								</a>
							</div>
							<time pubdate datetime='@post.PublicationMoment.ToString("d")'>@post.PublicationMoment.ToString("d")</time>
							@{
								var categoryList = (post.Categories as IEnumerable <dynamic>)
									.Select(cat => "<a class='category' href='" + Link.To(parameters: "category=" + cat.Key) + "' title='" + cat.Name + "'>" + cat.Name + "</a>").ToArray();
							}
							@Html.Raw(string.Join("", categoryList))
						</div>
					</div>
										
					<div class="content">
						@ToSic.SexyContent.ContentBlocks.Render.All(post, field: "DesignedContent", merge: post.Body) 
					</div>
					<div class="footer">
						@* show categories and tags *@
						<div class="tags">
							<strong> @(post.Tags.Count > 1 ? @App.Resources.Tags : @App.Resources.Tag): </strong>
							@{ var tagsList = (post.Tags as IEnumerable <dynamic>)
								.Select(tag => "<a " + @Koi.Class(@"bs3,unk='btn btn-sm btn-default' bs4='btn btn-sm btn-light'") + " href='" + Link.To(parameters: "tag=" + tag.Tag) + "' title='" + tag.Name + "'>" + tag.Name + "</a>").ToArray();
							}
							@Html.Raw(string.Join("", tagsList))
						</div>
						@* render social sharing here - to update the link, change it in the App settings *@
						<script type="text/javascript" src="@App.Settings.SocialAddThisJS" ></script> 
						<div class="addthis_inline_share_toolbox hidden-md hidden-lg"></div>
						<hr />
						@* show the author *@
						<div class="authordetails">
							<div>
								<img src='@author.Image.ToLower()?w=120&amp;h=120&amp;mode=crop&amp;quality=70' alt="@author.FullName"/> @Html.Raw(author.ShortBio)
							</div>
							<div>
								@App.Resources.ReadMoreAuthor <a href="@Link.To(parameters: "author=" + author.FullName)">@author.FullName</a>
							</div>
						</div>
						<hr />
						<div class="article-links">
						@RenderPage("_Post micro preview.cshtml", new { post = AsDynamic(Data["Previous"]).FirstOrDefault(), css = "previous", title = App.Resources.PreviousPost, leftIcon="glyphicon-arrow-left"})
						@RenderPage("_Post micro preview.cshtml", new { post = AsDynamic(Data["Next"]).FirstOrDefault(), css = "next", title = App.Resources.NextPost, rightIcon="glyphicon-arrow-right"})
						</div>
						<hr />
						<div class="backlink">
							<a @Koi.Class(@"all='btn' bs3,unk='btn-primary' bs4='btn-outline-primary'") href="@Link.To()" title="Home">@App.Resources.BackToHome</a>
						</div>
					</div>
					
					<div id="disqus_thread"></div>
					<script>

					/**
					*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
					*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
					/*
					var disqus_config = function () {
					this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
					this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
					};
					*/
					(function() { // DON'T EDIT BELOW THIS LINE
					var d = document, s = d.createElement('script');
					s.src = 'https://2sic-com.disqus.com/embed.js';
					s.setAttribute('data-timestamp', +new Date());
					(d.head || d.body).appendChild(s);
					})();
					</script>
					<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
				</article>
			</div>
			
			<div  @Koi.Class(@"bs3,unk='col-xs-12 col-sm-12 col-md-4 col-lg-4' bs4='col-xs-12 col-sm-12 col-md-12 col-lg-4 col-xl-4'")>
				<aside>
                	<div id="sidebar"  @Koi.Class(@"all='sidebar app-blog-detail-right' bs3,unk='hidden-xs hidden-sm' bs4='d-none d-sm-none d-md-none d-lg-block'")>
						<div class="sidebar__inner">
							@RenderPage("_category_sidebar.cshtml")
							@* render social sharing here - to update the link, change it in the App settings *@
							<script type="text/javascript" src="@App.Settings.SocialAddThisJS" ></script> 
							<div class="addthis_inline_share_toolbox"></div>
							@* show micro-previews for previous/next post *@
						
						</div>
						
					</div>
					@*only show on mobile view*@
					<div @Koi.Class(@"all='sidebar app-blog-detail-right' bs3,unk='visible-xs-block visible-sm-block hidden-md hidden-lg' bs4='d-lg-none d-xl-none'")>
						<div class="sidebar__inner">
							@RenderPage("_category_sidebar.cshtml")
						
						</div>
						
					</div>

				</aside>
			</div>
		</div>
		
</section>
@Koi.IfUnknown("<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css'>")

} else {
	@* this happens when an article isn't published yet *@
	Response.StatusCode = 404;
	Response.TrySkipIisCustomErrors = true;
	<h1>404 (not found)</h1>
	<p>
		<a class="@Koi.Class(@"bs3,unk='btn btn-primary' bs4='btn btn-outline-primary'")" href="@Link.To()" title="Home">@App.Resources.BackToHome</a>
	</p>
}
